## Country Administrative Divisions

Currently we have:

Admin Level 1 Province_Region_State

    country_id ‚Üí Link ‚Üí Country

    province_region_state ‚Üí Data (used for autoname)

Admin Division Level 2 Districts_County_City_Town

    admin_division_level_1 ‚Üí Link ‚Üí Admin Level 1 Province_Region_State

    district_county_city_town ‚Üí Data (used for autoname)


## We have our data directory structure like this:

üìÅ Directory Structure and location to place the csv files:

/home/hamza/frappe-bench/sites/{progress}/private/files/admin_divisions/

‚îú‚îÄ‚îÄ ghana/
‚îÇ   ‚îú‚îÄ‚îÄ level_1.csv
‚îÇ   ‚îî‚îÄ‚îÄ level_2.csv
‚îú‚îÄ‚îÄ kenya/
‚îÇ   ‚îú‚îÄ‚îÄ level_1.csv
‚îÇ   ‚îî‚îÄ‚îÄ level_2.csv
‚îú‚îÄ‚îÄ germany/
‚îÇ   ‚îú‚îÄ‚îÄ level_1.csv
‚îÇ   ‚îî‚îÄ‚îÄ level_2.csv


YOU CAN DOWNLOAD THE CSV FILES FROM HERE:
https://github.com/hamzabawumia/Common-Country-and-Global-Data-for-import-and-exports/tree/main

## We are using ISO STANDARDS FOR OUR COUNTRIES 
## - This is compartible with frappe's country doctype
### - It allows us to check if the country names matche what is in the Country master of ERPNext

level_1.csv
country_iso,province_region_state
GH,Ashanti
GH,Greater Accra

level_2.csv
country_iso,province_region_state,district_county_city_town
GH,Ashanti,Kumasi Metropolitan
GH,Greater Accra,Accra Metropolitan


‚úî No country names
‚úî ISO-only
‚úî Globally safe


## Location of our scripts and csv files:

‚úî Script ‚Üí utils/import_admin_divisions.py
‚úî CSVs ‚Üí sites/{sitename}/private/files/admin_divisions/{country}/


## - Here is the final code inside "import_admin_divisions.py"
## location of the .py script: 
/frappe-bench/apps/country_administrative_divisions/country_administrative_divisions/utils
NOTE THAT: utils folder is in the same directory as hooks.py and www folder

import frappe
import csv
import os

BASE_PATH = frappe.get_site_path("private", "files", "admin_divisions")


def get_country_by_iso(iso_code):
    country = frappe.db.get_value(
        "Country",
        {"code": iso_code.upper()},
        "name"
    )
    if not country:
        frappe.throw(f"‚ùå Country ISO not found: {iso_code}")
    return country


def import_country(country_folder):
    level_1_file = f"{BASE_PATH}/{country_folder}/level_1.csv"
    level_2_file = f"{BASE_PATH}/{country_folder}/level_2.csv"

    import_admin_level_1(level_1_file)
    import_admin_level_2(level_2_file)


def import_admin_level_1(file_path):
    with open(file_path, encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            country = get_country_by_iso(row["country_iso"])

            if not frappe.db.exists(
                "Admin Level 1 Province_Region_State",
                {
                    "country_id": country,
                    "province_region_state": row["province_region_state"],
                },
            ):
                frappe.get_doc({
                    "doctype": "Admin Level 1 Province_Region_State",
                    "country_id": country,
                    "province_region_state": row["province_region_state"],
                }).insert(ignore_permissions=True)

    frappe.db.commit()


def import_admin_level_2(file_path):
    with open(file_path, encoding="utf-8") as f:
        reader = csv.DictReader(f)
        for row in reader:
            country = get_country_by_iso(row["country_iso"])

            parent = frappe.db.get_value(
                "Admin Level 1 Province_Region_State",
                {
                    "country_id": country,
                    "province_region_state": row["province_region_state"],
                },
                "name",
            )

            if not parent:
                frappe.throw(
                    f"Missing Admin Level 1: {row['province_region_state']} ({country})"
                )

            if not frappe.db.exists(
                "Admin Division Level 2 Districts_County_City_Town",
                {
                    "admin_division_level_1": parent,
                    "district_county_city_town": row["district_county_city_town"],
                },
            ):
                frappe.get_doc({
                    "doctype": "Admin Division Level 2 Districts_County_City_Town",
                    "admin_division_level_1": parent,
                    "district_county_city_town": row["district_county_city_town"],
                }).insert(ignore_permissions=True)

    frappe.db.commit()


## Example Usage (Bench Console)
bench --site progress console

from country_administrative_divisions.utils.import_admin_divisions import import_country

import_country("ghana") --- Note that we are using country names with all lower case.


Or all countries:

from country_administrative_divisions.utils.import_admin_divisions import import_all_countries

import_all_countries()


